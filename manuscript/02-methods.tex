% ---------------------------------------------------------------------------------------
\section*{Methods} 
% ---------------------------------------------------------------------------------------



% ---------------------------------------------------------------------------------------
\subsection*{Data and population estimates} 
% ---------------------------------------------------------------------------------------

From 1991 to 2020, surveys of the stickleback population were conducted twice annually, 
the first in either June or July and second in August or September. 
Samples were collected from 5 stations in the south basin and 3 stations in the north basin.
These stations provided wide coverage of the two basins, 
with the exception of sites near the shoreline 
(sampling of shoreline sites began in 2008 but those data are not included here)
and of the eastern portion of the south basin which historically has had negligible 
densities of sticklebacks.
For each sampling event at each station, 
5 traps were set for two 12-hour sessions, 
one during the day and one during the night.
Individuals were sorted into two size classes before being counted,
with a threshold of 50mm in the June/July sampling and 45mm in the August/September sampling.
These size categories roughly map onto sexual maturity,
and while although there is likely variation in size-at-maturation
it should serve as a reasonable approximation for the purpose 
of modeling the population dynamics.
Within each basin and size class, 
station catches were of comparable magnitude and 
strongly synchronized through time (Supplemenal materials).
Therefore, our analysis focused on the dynamics of basin-level abundances
of the two size classes through time.

To account for systematic variation in trapping probability between size classes,
trapping stations, and time of day, 
we fit a modified N-mixture model \citep{royle2004}
to the trap-level data to estimate mean population density across sampling stations 
for each basin $\times$ size-class combination at each time point.
(Appendix X). 
We then scaled these relative density estimates by the relative samplings areas 
of the two basins, 
which we defined as the entire north basin and the south basin west of a chain
of islands beyond which there are no trapping data 
due to historically low stickleback abudance.
This resulted in a 2:1 relative scaling for the south vs. north basin.
Both the relative density and relative abundance (after scaling by area) of threespine
stickleback was generally higher in the north basin than in the south,
consistent with a mark-recapture study conducted in 1989 \citep{gislason1998}



% ---------------------------------------------------------------------------------------
\subsection*{Structured population model} 
% ---------------------------------------------------------------------------------------

We used a stage-structured metapopulation model \citep{caswell2001matrix}
with time-varying demographic rates
to characterize the dynamics of the stickleback population. 
The model projected the population dynamics due to 
within-basin recruitment, survival, and development, 
as well as dispersal between basins. 
Recruitment, survival, and dispersal were allowed to vary through time,
enabling the model to characterize a range of dynamics, 
including those implicitly due to endogenous (e.g., density dependence) 
and exogenous (e.g, environmental variation) processes
\citep{zeng1998, ives2012}. 
We estimated the demographic rates by  
fitting the model to the time series of abundance estimates. 
In general terms, this approach works by reconstructing the demographic rates required
to project the distribution of abundances across demographic states 
from one time step to the next. 
While parameter identifiability poses a challenge for such inferences over a single time
step, by explicitly modeling temporal variation in the demographic rates we were able 
to take advantage of shared information across all time points simultaneously to 
successfully constrain the parameter estimates.
The resulting demographic rates are best understood as parameters 
characterizing the observed population dynamics, 
rather than as individual-level demographic rates that would be estimated through a 
technique such as mark-recapture. 

For a given time interval from $t-1$ to $t$, 
the structured population dynamics were projected as
%
\begin{equation} \label{eq:XPX}
    \mathbf{x}_t = \mathbf{P}_{t-1}~\mathbf{x}_{t-1}
\end{equation}
%
where $\mathbf{P}_{t}$ is 4 $\times$ 4 a matrix of demographic rates at time $t$, 
and $\mathbf{x}_{t}$ is a 4 $\times$ 1 vector of abundances 
for a given stage (juveniles $j$; adults $a$) 
and basin (south $s$; north $n$):
%
\begin{equation} \label{eq:X}
\mathbf{x}_{t} = 
\left[
\begin{array}{cccc}
    {x_{j,s,t}} \\
    {x_{a,s,t}} \\
    {x_{j,n,t}} \\
    {x_{a,n,t}}
    \end{array}
\right]
\text{.}
\end{equation}
%
The projection matrix $\mathbf{P}_{t}$ can be expressed as
%
\begin{equation} \label{eq:P}
\mathbf{P}_{t} = 
\left[
\begin{array}{c|ccc}
    \mathbf{W}_{s,t}  & \mathbf{B}_{s\rightarrow n,t} \\
    \hline
    \mathbf{B}_{n\rightarrow s,t} & \mathbf{W}_{n,t}
    \end{array}
\right]
\end{equation}
%
where $\mathbf{W}_{i,t}$ is a 2 $\times$ 2 matrix characterizing 
per capita contributions within basin $i$,
and $\mathbf{B}_{i\rightarrow k,t}$ is a 2 $\times$ 2 matrix characterizing 
contributions from basin $i$ to basin $k$.
Within-basin contributions were modeled as 
 %
\begin{equation} \label{eq:W}
\mathbf{W}_{i,t} = 
\left[
\begin{array}{cccc}
    \phi_{j,i,t}~(1-\gamma_{j}) & 
    \rho_{i,t} \\
    \phi_{j,i,t}~\gamma_{j}~(1-\delta_{a,i,t}) & 
    \phi_{a,i,t}~(1-\delta_{a,i,t})
    \end{array}
\right]
\end{equation}
%
where $\phi_{h,i,t}$ is the survival probability of life-stage $h$, 
$\gamma_{j}$ is the proportion of surviving juveniles that develop into adults,
$\delta_{a,i,t}$ is the proportion of surviving adults that disperse to the other basin,
and $\rho_{i,t}$ is per capita recruitment.
We modeled between-basin contributions as
%
\begin{equation} \label{eq:B}
\mathbf{B}_{i,t} = 
\left[
\begin{array}{cccc}
    0 & 
    0 \\
    
    \phi_{j,i,t}~\gamma_{j}~\delta_{a,i,t} & 
    \phi_{a,i,t}~\delta_{a,i,t}
    \end{array}
\right].
\end{equation}
%
We fixed $\gamma_{j}$ to a single value for both basins and through time because 
it was difficult to statistically separate changes in development from changes 
in survival probability.
This is unsurprising, as both survival and development probabilities
determined the contribution of juveniles to the adult age class,
and the development probability was sufficiently 
high that few juveniles returned to the juvenile class at the next time step. 
Similarly, we assumed that only individuals that were adults at the end of the projection
interval dispersed, because a model allowing juveniles to disperse failed to detect 
a meaningful signature of net juvenile dispersal 
(again due to the high probability of development over the course of a projection interval).
Taken literally, the model implies that individuals born in a given basin
remain within that basin until the next time step.
However, any recruitment across basins should largely manifest 
as additional temporal variability in the within-basin recruitment,
and therefore is implicitly accommodated by the model.
Furthermore, gravid females and males in breeding coloration are 
routinely found in both basins, making it likely that spawning occurs in each.

To accommodate the unequal duration of the the summer (2-3 months) and winter (9-10 month)
intervals, we modeled the transition probabilities 
($\phi_{h,i,t}$, $\gamma_{j}$, and $\delta_{a,i,t}$)
in terms of latent transition rates $\omega^{\alpha}_{t}$ 
(where $\alpha$ denotes the corresponding demographic parameter).
For each class of transition process (mortality, development, and dispersal),
we specified a transition matrix from which we could then calculate
the probability of transition over a given interval $\Delta T$ 
(see Appendix \ref{sec:A1}).
We did not explicitly model unequal projection intervals for reproduction,
as spawning was not evenly spread throughout the year but instead was concentrated
in the summer (but spanned the ``summer'' and ``winter'' sampling periods).

We modeled temporal variation in demographic rates
(including for $\alpha$ = $\rho_{i,t})$ as random walks:
%
\begin{equation} \label{eq:theta}
    \omega^{\alpha}_t & \sim \text{Normal}
        \left(
            \omega^{\alpha}_{t-1},~\sigma_{g[\alpha]}}
        \right) \text{T}(0, \infty)
\end{equation}
%
with standard deviation $\sigma_{g[\alpha]$ and 
truncated from the left to ensure that values remained positive. 
The function $g$ maps $\alpha$ to a given type of demographic process 
(reproduction, mortality, or dispersal),
such that a single random walk standard deviation was used 
for each type of demographic process.
While formulated as random walks, 
the realized sequences of inferred demographic rates 
were not truly random walks because they were constrained by fitting the model to data.
Therefore, the ``random walks'' are best understood as a convenient method 
for allowing the demographic rates to vary through time with implicit ``smoothing''
arising from the autocorrelated nature of the walks.

We fit the model in a Bayesian framework, 
using the abundance estimates from the trapping data. 
The likelihood of the ``observed'' abundance given the projected abundances 
and standard deviation $\sigma_y$ was calculated as
%
\begin{equation} \label{eq:likelihood}
\mathcal{L} = 
\displaystyle\prod_{h}
\displaystyle\prod_{i}
\displaystyle\prod_{t}
\text{Normal}
    \left(
        y_{h,i,t}~|~x_{h,i,t},~\sigma_y
    \right).
\end{equation}
%
For population densities that are necessarily non-negative, 
it is common to model the likelihood using a distribution that is similarly constrained,
such as a log-normal distribution. 
However, the multiplicative nature of population processes is already entailed 
in the population projection, 
and a log-normal likelihood reduces the relative contribution of large population sizes
that likely reflect meaningful dynamics.
Therefore, we opted for a normal (Gaussian) likelihood. 
Because the model was parameterized in a way that ensured
$x_{h,i,t}$ was non-negative,
the posterior distribution of $x_{h,i,t}$ was also guaranteed to be non-negative. 
We used gamma priors with shape parameter 1.5 and scale parameter 0.75
for the initial population size for each stage $\times$ basin combination, 
initial values for random walks,
and standard deviations for the random walks and likelihood.
A gamma distribution with shape parameter of 1.5 has zero density at zero 
and is concave down as it approaches its mode,
allowing the posterior to be arbitrarily close to zero 
while not being artificially drawn towards it.
This shape parameter, along with scale parameter of 0.75,
implies a mean of 2, 
which defines a reasonable scale for all of the parameters 
following the scaling of the population estimates (see below).

We fit the model using Stan 2.19 \citep{Carpenter2017}
run from R 4.0.0 with the \emph{rstan} package \citep{Stan2018}.
To facilitate selection of prior parameterizations,
we scaled the population estimates by dividing by the mean,
such that the resulting in data that had a mean of 1
and ranged from approximately 0 to 11.
We fit the model with 4 chains, 
15000 iterations (7500 of warm-up and 7500 of sampling),
and set the ``adapt-delta'' parameter to 0.9.
Convergence was assessed by the number of divergent transitions 
and the potential scale reduction factor (\^{R}),
which quantifies the relative variance within and between chains. 
We used posterior medians as point estimates
and quantiles (16\% and 84\%) as uncertainty intervals, 
with coverage analogous to standard errors.

To assess the extent to which the data supported statistically meaningful inferences
of temporal variation in demographic rates,
we compared the fit of the model to a reduced version will all demographic rates
fixed through time
(while still accounting for the unequal projection interval for transition probabilities).
We assessed goodness-of-fit using two metrics:
(1) the posterior median of the logarithm
of the likelihood given by equation \ref{eq:likelihood}
and (2) the ``Leave-one-out Information Criterion'' or LOOIC,
which is analogous to the Akaike Information Criterion (AIC)
and can be interpreted in a similar manner.
We calculated LOOIC using the \emph{loo} package \citep{loo}.
The full model had a much higher log-likelihood (posterior median: -230 vs. -378)
and much lower LOOIC (657 vs. 809) than the reduced model,
indicating that allowing temporal variation in demographic rates provided a
substantially improved fit to the data.



%========================================================================================

\subsection*{Annual dynamics and sensitivity analysis} 

%========================================================================================

While we parameterized the model in terms of seasonal projections
to accommodate the seasonal nature of the data,
we focused our analysis on the annual dynamics to better reflect
the annual nature of spawning and to circumvent interpretational
issues arising from the unequal projection intervals within a year.
Accordingly, we defined the annual projection matrix as
%
\begin{equation} \label{eq:A}
\mathbf{A}_y = \mathbf{P}_{t[y]+1} \mathbf{P}_{t[y]}
\end{equation}
%
for year $y$ and sequential time steps within that year $t[y]$ and $t[y]+1$,
with the year defined to start with the June/July census.
$\mathbf{A}_y$ projects the dynamics from
June/July of one year to June/July of the next year.
Because $\mathbf{P}_{t[y]$ was defined through June of 2020,
we only calculated $\mathbf{A}_y$ from 1991 through 2019.

We characterized the overall dynamics of the population in terms of the annual 
population growth rate $\lambda_y$, calculated as
%
\begin{equation} \label{eq:lam-n}
\lambda_y = \frac{N_{y+1}}{N_y} = 
              \frac{\mathbf{c}^\top \mathbf{A}_y \mathbf{x}_y}
                    {\mathbf{c}^\top \mathbf{x}_y}} 
\end{equation}
%
where $N_y$ is the summed abundance across basins and life stages in year $y$
and $\mathbf{c}$ is a 4 $\times$ 1 vector of ones.
Temporal variation in $\lambda_y$ reflects both variation in the demographic rates
and transient fluctuations due to non-equilibrium state distributions. 
Therefore, it is also informative to calculate 
the asymptotic population growth rate that 
would obtain under the equilibrium state distribution in a given time step, 
which is equal to real part of the leading eigenvalue of $\mathbf{A}_y$ 
\citep{caswell2001matrix}.

Both the transient and asymptotic population growth rates appeared to display periodic
behavior for at least a portion of the three decade time series.
We quantified this putative periodicity by applying continuous wavelet transforms to 
the time series for the transient and asymptotic growth rates, 
on a log-scale (the results were similar for the raw values) 
and with no detrending.
Wavelet transforms are a generalization of Fourier transforms,
allowing the decomposition of the signal into periodic elements to be localized in time. 
As our use of wavelet transforms was chiefly descriptive and applied to signals 
that were themselves the outputs of a statistical model,
we did not attempt to apply formal statistical inference (i.e. hypothesis testing)
to the wavelet decomposition.
We conducted the wavelet analysis using the R package \emph{WaveletComp},
and for tractability we applied the wavelet transform 
to the posterior median of $\lambda_y$ (rather than to multiple Markov chain samples).

Periodic population fluctuations are often attributable to density-dependent processes,
such as consumer-resource and host-parasite interactions.
To provide a general assessment of density dependence,
we regressed the log-transformed population growth rate ($\lambda_y$)
against overall population size ($N_y$) as inferred from the full demographic model.
The model was fit using the ``gls'' function from the ``nlme'' package in R,
inclcuding a lag-1 autocorrelation structure in the residuals,
although this had a limited effect on the overall inference.
We report this analysis for the asymptotic growth rate,
as classical mechanisms of density dependence processes 
arise through direct changes in the demographic rates, 
which in turn manifest in the asymptotic growth rate.
However, the results for the transient growth rate were similar. 
The regression was performed for 1000 Markov chain samples
to propagate uncertainty in $\lambda_y$ and $N_y$.

We conducted a sensitivity analysis to evaluate the effect of perturbations 
in the demographic rates on the population growth rate, 
using the approach of \cite{caswell2007sensitivity} 
that is applicable to transient dynamics. 
The sensitivity of the population growth rate with respect to a demographic parameter
quantifies how much the growth rate would change in response to a perturbation in the 
demographic parameter. 
In order to compare across parameters of different values 
(which is particularly relevant in the present context with time-varying rates),
it is common to calculate sensitivities 
in response to proportional (as opposed to additive) perturbations,
otherwise known as ``elasticities''.
For each year, we calculated the elasticity of the annual growth rate with respect
to the demographic rates at each of the two time steps within that year.
To simplify the presentation, 
we added together the two elasticities for a given demographic parameter 
(e.g. recruitment of south basin juveniles) for each year.
We conducted the sensitivity analysis for both transient and asymptotic growth rates.
Transient sensitivity analysis propagates perturbations in the demographic rates 
through time, 
such that transience due to non-equilibrium state distributions is attributed to the
demographic parameters resulting in the non-equilibrium state distribution 
for a given time step
\citep[][relevant equations are reproduced in Appendix X]{caswell2007sensitivity}.
The propagation interval for each perturbation was one year, 
such that we obtained a sequence of yearly elasticities 
for each seasonal demographic rate.
We obtained approximate asymptotic results by propagating each yearly perturbation
for 100 time steps before applying the next perturbation corresponding to the next year.
The sensitivity analysis was performed for 1000 samples of the Markov chain generated during fitting of the full demographic model to propagate uncertainty parameter estimates.




  



